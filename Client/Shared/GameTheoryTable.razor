@using System.Text.Json
@using Blazored.LocalStorage
@inject ISyncLocalStorageService LocalStorage
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ClipboardService Clipboard

<MudStack AlignItems="AlignItems.Center">
    <MudStack Row>
        <MudSelect Style="min-width: 400px" Variant="Variant.Filled" Clearable @bind-Value="@CurrentTable">
            @foreach (GameTheoryTableData table in Tables)
            {
                <MudSelectItem Value="table">@table.TableIdentifier</MudSelectItem>
            }
        </MudSelect>
        <MudIconButton Variant="Variant.Filled" Icon="@Icons.Material.Filled.Add" OnClick="@OnClickAddTable" />
        <MudIconButton Variant="Variant.Filled" Icon="@Icons.Material.Filled.Remove" OnClick="@OnClickRemoveTable" />
        <MudIconButton Variant="Variant.Filled" Icon="@Icons.Material.Filled.Save" OnClick="@SaveTables" />
        <MudButton Variant="Variant.Filled" OnClick="@ResetTablesToDefault">Default All Tables</MudButton>
        <MudButton Variant="Variant.Filled" OnClick="@PasteTable">Paste Table From Clipboard</MudButton>
    </MudStack>
    @if (CurrentTable is not null)
    {
        <GameTheoryInnerTable TableData="@CurrentTable"/>
    }
</MudStack>

@code {

    private const string GameTheoryTablesKey = "GameTheoryTables";

    private List<GameTheoryTableData> Tables { get; set; } = [];
    private GameTheoryTableData? CurrentTable { get; set; }


    private async Task SaveTables()
    {
        Snackbar.Add("Tables Saved", Severity.Success);
        LocalStorage.SetItem(GameTheoryTablesKey, Tables);
    }

    private async Task OnClickAddTable()
    {
        GameTheoryTableData table = new();
        Tables.Add(table);
        CurrentTable = table;
    }

    private async Task OnClickRemoveTable()
    {
        if (CurrentTable is not null)
        {
            bool? result = await DialogService.ShowMessageBox(
                "Remove Table", 
                "Are you sure you wanna do that?", 
                yesText:"yeah", cancelText:"nah");
            if (result is true)
            {
                Tables.Remove(CurrentTable);
                CurrentTable = Tables.FirstOrDefault();
                StateHasChanged();
            }
        }
    }

    private async Task ResetTablesToDefault()
    {
        bool? result = await DialogService.ShowMessageBox(
            "Default all tables", 
            "Are you sure you wanna do that?", 
            yesText:"yeah", cancelText:"nah");
        if (result is true)
        {
            Tables =
            [
                GameTheoryTableDefaults.WakeupVsSol,
                GameTheoryTableDefaults.BaikenMirrorHkabRPS,
            ];
            CurrentTable = Tables.FirstOrDefault();
            StateHasChanged();
        }
    }

    private async Task PasteTable()
    {
        try
        {
            string? json = await Clipboard.ReadTextAsync();
            var table = JsonSerializer.Deserialize<GameTheoryTableData>(json);
            Tables.Add(table);
            CurrentTable = table;
            Snackbar.Add("Table Pasted", Severity.Success);
        }
        catch (JsonException e)
        {
            Snackbar.Add("Invalid Paste", Severity.Error);
        }
        catch (ArgumentNullException e)
        {
            Snackbar.Add("Unknown Paste Error", Severity.Error);
        }
    }
    
    protected override async Task OnInitializedAsync()
    {
        if (LocalStorage.TryGetItem(GameTheoryTablesKey, out List<GameTheoryTableData>? item))
        {
            try
            {
                Console.WriteLine("tables loaded");
                Tables       = item;
                CurrentTable = item.FirstOrDefault();
            }
            catch (Exception e)
            {
                Console.WriteLine("error loading tables");
            }
        }
        else
        {
            Console.WriteLine("no table found");
            Tables =
            [
                GameTheoryTableDefaults.WakeupVsSol,
                GameTheoryTableDefaults.BaikenMirrorHkabRPS,
            ];
            CurrentTable = Tables.FirstOrDefault();
            StateHasChanged();
        }
    }
}
