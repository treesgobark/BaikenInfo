@using System.Text.Json
@using Blazored.LocalStorage
@inject ISyncLocalStorageService LocalStorage
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ClipboardService Clipboard

<MudStack AlignItems="AlignItems.Center">
    <MudStack Row AlignItems="AlignItems.Center">
        <MudSelect Variant="Variant.Filled" Clearable Style="min-width: 250px" Label="Your Character" @bind-Value="@YourCharacterFilter">
            @foreach (StriveCharacter character in Enum.GetValues<StriveCharacter>())
            {
                <MudSelectItem Value="@character">@(Enum.GetName(character))</MudSelectItem>
            }
        </MudSelect>
        <MudText>vs</MudText>
        <MudSelect Variant="Variant.Filled" Clearable Style="min-width: 250px" Label="Enemy Character" @bind-Value="@EnemyCharacterFilter">
            @foreach (StriveCharacter character in Enum.GetValues<StriveCharacter>())
            {
                <MudSelectItem Value="@character">@(Enum.GetName(character))</MudSelectItem>
            }
        </MudSelect>
        <MudText>:</MudText>
        <MudSelect Label="Select Table" Style="min-width: 300px" Variant="Variant.Filled" @bind-Value="@CurrentTable">
            @if (ReadOnlyTables.Any())
            {
                <MudSelectItem T="GameTheoryTableData" Disabled>Built-in Tables</MudSelectItem>
                @foreach (GameTheoryTableData table in ReadOnlyTables)
                {
                    <MudSelectItem Value="table">@table.TableIdentifier</MudSelectItem>
                }
            }
            @if (UserTables.Any())
            {
                <MudSelectItem Value="@((GameTheoryTableData?)null)" Disabled>User Tables</MudSelectItem>
                foreach (GameTheoryTableData table in UserTables)
                {
                    <MudSelectItem Value="table">@table.TableIdentifier</MudSelectItem>
                }
            }
        </MudSelect>
        <MudIconButton Variant="Variant.Filled" Icon="@Icons.Material.Filled.Add" OnClick="@OnClickAddTable"/>
        <MudIconButton Variant="Variant.Filled" Icon="@Icons.Material.Filled.Remove" OnClick="@OnClickRemoveTable"/>
        <MudIconButton Variant="Variant.Filled" Icon="@Icons.Material.Filled.Save" OnClick="@SaveTables"/>
    </MudStack>
    <MudStack Row AlignItems="AlignItems.Center">
        <MudButton Variant="Variant.Filled" OnClick="@OnClickResetTables">Clear User Tables</MudButton>
        <MudButton Variant="Variant.Filled" OnClick="@PasteTable">Paste Table From Clipboard</MudButton>
    </MudStack>
    @if (CurrentTable is not null)
    {
        <GameTheoryInnerTable TableData="@CurrentTable"/>
    }
</MudStack>

@code {

    private const string GameTheoryTablesKey = "GameTheoryTables";

    private List<GameTheoryTableData> Tables { get; set; } = [];
    private GameTheoryTableData? CurrentTable { get; set; }

    private StriveCharacter YourCharacterFilter { get; set; }
    private StriveCharacter EnemyCharacterFilter { get; set; }

    private IEnumerable<GameTheoryTableData> FilteredTables => Tables
       .Where(t => (t.YourCharacter     == YourCharacterFilter  || YourCharacterFilter  == StriveCharacter.Default)
                   && (t.EnemyCharacter == EnemyCharacterFilter || EnemyCharacterFilter == StriveCharacter.Default));
    
    private IEnumerable<GameTheoryTableData> ReadOnlyTables => FilteredTables.Where(t => t.ReadOnly);
    private IEnumerable<GameTheoryTableData> UserTables => FilteredTables.Where(t => !t.ReadOnly);

    private async Task SaveTables()
    {
        Snackbar.Add("Tables Saved", Severity.Success);
        LocalStorage.SetItem(GameTheoryTablesKey, Tables.Where(t => !t.ReadOnly));
    }

    private async Task OnClickAddTable()
    {
        GameTheoryTableData table = new();
        Tables.Add(table);
        CurrentTable = table;
    }

    private async Task OnClickRemoveTable()
    {
        if (CurrentTable is { ReadOnly: false })
        {
            bool? result = await DialogService.ShowMessageBox(
                "Remove Table", 
                "Are you sure you wanna do that?", 
                yesText:"yeah", cancelText:"nah");
            if (result is true)
            {
                Tables.Remove(CurrentTable);
                CurrentTable = Tables.FirstOrDefault();
                StateHasChanged();
            }
        }
    }

    private async Task OnClickResetTables()
    {
        bool? result = await DialogService.ShowMessageBox(
            "Default all tables", 
            "Are you sure you wanna do that?", 
            yesText:"yeah", cancelText:"nah");
        if (result is true)
        {
            ResetTables();
            await SaveTables();
        }
    }

    private void ResetTables()
    {
        Tables =
        [
            GameTheoryTableDefaults.WakeupVsSol,
            GameTheoryTableDefaults.BaikenMirrorHkabRPS,
            GameTheoryTableDefaults.BaikenVsSolSkabRps,
        ];
        CurrentTable = Tables.FirstOrDefault();
        StateHasChanged();
    }

    private async Task PasteTable()
    {
        try
        {
            string? json = await Clipboard.ReadTextAsync();
            var table = JsonSerializer.Deserialize<GameTheoryTableData>(json);
            Tables.Add(table);
            CurrentTable = table;
            Snackbar.Add("Table Pasted", Severity.Success);
        }
        catch (JsonException e)
        {
            Snackbar.Add("Invalid Paste", Severity.Error);
        }
        catch (ArgumentNullException e)
        {
            Snackbar.Add("Unknown Paste Error", Severity.Error);
        }
    }
    
    protected override async Task OnInitializedAsync()
    {
        ResetTables();
        if (LocalStorage.TryGetItem(GameTheoryTablesKey, out List<GameTheoryTableData>? item))
        {
            try
            {
                Console.WriteLine("tables loaded");
                Tables.AddRange(item);
                CurrentTable = item.FirstOrDefault(t => !t.ReadOnly) ?? CurrentTable;
            }
            catch (Exception e)
            {
                Console.WriteLine("error loading tables");
            }
        }
        else
        {
            Console.WriteLine("no table found");
        }
    }
}
